/*! squaire 07-12-2015 */
!function(a,b){"function"==typeof define&&define.amd?define(["d3"],b):"object"==typeof module&&module.exports?module.exports=function(a){return a.tip=b(a),a.tip}:a.d3.tip=b(a.d3)}(this,function(a){return function(){function b(a){x=p(a),y=x.createSVGPoint(),document.body.appendChild(v)}function c(){return"n"}function d(){return[0,0]}function e(){return" "}function f(b){return a.select(b)}function g(){var a=r();return{top:a.n.y-v.offsetHeight-t()[0],left:a.n.x-v.offsetWidth/2}}function h(){var a=r();return{top:a.s.y+t()[0],left:a.s.x-v.offsetWidth/2}}function i(){var a=r();return{top:a.e.y-v.offsetHeight/2,left:a.e.x+t()[1]}}function j(){var a=r();return{top:a.w.y-v.offsetHeight/2,left:a.w.x-v.offsetWidth-t()[1]}}function k(){var a=r();return{top:a.nw.y-v.offsetHeight,left:a.nw.x-v.offsetWidth}}function l(){var a=r();return{top:a.ne.y-v.offsetHeight,left:a.ne.x}}function m(){var a=r();return{top:a.sw.y,left:a.sw.x-v.offsetWidth}}function n(){var a=r();return{top:a.se.y,left:a.e.x}}function o(){var b=a.select(document.createElement("div"));return b.style({position:"absolute",top:0,opacity:0,"pointer-events":"none","box-sizing":"border-box"}),b.node()}function p(a){return a=a.node(),"svg"===a.tagName.toLowerCase()?a:a.ownerSVGElement}function q(){return null===v&&(v=o(),document.body.appendChild(v)),a.select(v)}function r(){for(var b=z||a.event.target;"undefined"==typeof b.getScreenCTM&&"undefined"===b.parentNode;)b=b.parentNode;var c={},d=b.getScreenCTM(),e=b.getBBox(),f=e.width,g=e.height,h=e.x,i=e.y;return y.x=h,y.y=i,c.nw=y.matrixTransform(d),y.x+=f,c.ne=y.matrixTransform(d),y.y+=g,c.se=y.matrixTransform(d),y.x-=f,c.sw=y.matrixTransform(d),y.y-=g/2,c.w=y.matrixTransform(d),y.x+=f,c.e=y.matrixTransform(d),y.x-=f/2,y.y-=g/2,c.n=y.matrixTransform(d),y.y+=g,c.s=y.matrixTransform(d),c}var s=c,t=d,u=e,v=o(),w=f(".squaire-toolbox"),x=null,y=null,z=null;b.show=function(a,c,d){var e=Array.prototype.slice.call(arguments);e[e.length-1]instanceof SVGElement&&(z=e.pop());var f,g=u.apply(this,e),h=(t.apply(this,e),s.apply(this,e)),i=q(),j=w.apply(this,e),k=B.length,l=document.documentElement.scrollTop||document.body.scrollTop,m=document.documentElement.scrollLeft||document.body.scrollLeft;for(d||i.html(g).style({opacity:1,"pointer-events":"all"}),j.html(g);k--;)i.classed(B[k],!1);return f=A.get(h).apply(this),i.classed(h,!0).style({top:f.top+l+"px",left:f.left+m+"px"}),b},b.hide=function(){var a=q();return a.style({opacity:0,"pointer-events":"none"}),b},b.attr=function(c){if(arguments.length<2&&"string"==typeof c)return q().attr(c);var d=Array.prototype.slice.call(arguments);return a.selection.prototype.attr.apply(q(),d),b},b.style=function(c){if(arguments.length<2&&"string"==typeof c)return q().style(c);var d=Array.prototype.slice.call(arguments);return a.selection.prototype.style.apply(q(),d),b},b.direction=function(c){return arguments.length?(s=null==c?c:a.functor(c),b):s},b.offset=function(c){return arguments.length?(t=null==c?c:a.functor(c),b):t},b.html=function(c){return arguments.length?(u=null==c?c:a.functor(c),b):u},b.toolbox=function(c){return arguments.length?(w=null==c?c:a.functor(f(c)),b):w},b.destroy=function(){return v&&(q().remove(),v=null),b};var A=a.map({n:g,s:h,e:i,w:j,nw:k,ne:l,sw:m,se:n}),B=A.keys();return b}}),window.Squaire=function(){function a(a,b){var c=this,d={el:"#map-container",layout:[[0,0,"AK"],[10,0,"ME"],[9,1,"VT"],[10,1,"NH"],[0,2,"WA"],[1,2,"ID"],[2,2,"MT"],[3,2,"ND"],[4,2,"MN"],[6,2,"MI"],[8,2,"NY"],[9,2,"MA"],[10,2,"RI"],[0,3,"OR"],[1,3,"UT"],[2,3,"WY"],[3,3,"SD"],[4,3,"IA"],[5,3,"WI"],[6,3,"IN"],[7,3,"OH"],[8,3,"PA"],[9,3,"NJ"],[10,3,"CT"],[0,4,"CA"],[1,4,"NV"],[2,4,"CO"],[3,4,"NE"],[4,4,"MO"],[5,4,"IL"],[6,4,"KY"],[7,4,"WV"],[8,4,"VA"],[9,4,"MD"],[10,4,"DE"],[1,5,"AZ"],[2,5,"NM"],[3,5,"KS"],[4,5,"AR"],[5,5,"TN"],[6,5,"NC"],[7,5,"SC"],[8,5,"DC"],[3,6,"OK"],[4,6,"LA"],[5,6,"MS"],[6,6,"AL"],[7,6,"GA"],[0,7,"HI"],[3,7,"TX"],[8,7,"FL"]],labels:{AK:{full:"Alaska","short":"AK",ap:"Alaska"},AL:{full:"Alabama","short":"AL",ap:"Ala."},AR:{full:"Arkansas","short":"AR",ap:"Ark."},AZ:{full:"Arizona","short":"AZ",ap:"Ariz."},CA:{full:"California","short":"CA",ap:"Calif."},CO:{full:"Colorado","short":"CO",ap:"Colo."},CT:{full:"Connecticut","short":"CT",ap:"Conn."},DC:{full:"District of Columbia","short":"DC",ap:"D.C."},DE:{full:"Delaware","short":"DE",ap:"Del."},FL:{full:"Florida","short":"FL",ap:"Fla."},GA:{full:"Georgia","short":"GA",ap:"Ga."},HI:{full:"Hawaii","short":"HI",ap:"Hawaii"},IA:{full:"Iowa","short":"IA",ap:"Iowa"},ID:{full:"Idaho","short":"ID",ap:"Idaho"},IL:{full:"Illinois","short":"IL",ap:"Ill."},IN:{full:"Indiana","short":"IN",ap:"Ind."},KS:{full:"Kansas","short":"KS",ap:"Kan."},KY:{full:"Kentucky","short":"KY",ap:"Ky."},LA:{full:"Louisiana","short":"LA",ap:"La."},MA:{full:"Massachusetts","short":"MA",ap:"Mass."},MD:{full:"Maryland","short":"MD",ap:"Md."},ME:{full:"Maine","short":"ME",ap:"Maine"},MI:{full:"Michigan","short":"MI",ap:"Mich."},MN:{full:"Minnesota","short":"MN",ap:"Minn."},MO:{full:"Missouri","short":"MO",ap:"Mo."},MS:{full:"Mississippi","short":"MS",ap:"Miss."},MT:{full:"Montana","short":"MT",ap:"Mont."},NC:{full:"North Carolina","short":"NC",ap:"N.C."},ND:{full:"North Dakota","short":"ND",ap:"N.D."},NE:{full:"Nebraska","short":"NE",ap:"Neb."},NH:{full:"New Hampshire","short":"NH",ap:"N.H."},NJ:{full:"New Jersey","short":"NJ",ap:"N.J."},NM:{full:"New Mexico","short":"NM",ap:"N.M."},NV:{full:"Nevada","short":"NV",ap:"Nev."},NY:{full:"New York","short":"NY",ap:"N.Y."},OH:{full:"Ohio","short":"OH",ap:"Ohio"},OK:{full:"Oklahoma","short":"OK",ap:"Okla."},OR:{full:"Oregon","short":"OR",ap:"Ore."},PA:{full:"Pennsylvania","short":"PA",ap:"Pa."},RI:{full:"Rhode Island","short":"RI",ap:"R.I."},SC:{full:"South Carolina","short":"SC",ap:"S.C."},SD:{full:"South Dakota","short":"SD",ap:"S.D."},TN:{full:"Tennessee","short":"TN",ap:"Tenn."},TX:{full:"Texas","short":"TX",ap:"Texas"},UT:{full:"Utah","short":"UT",ap:"Utah"},VA:{full:"Virginia","short":"VA",ap:"Va."},VT:{full:"Vermont","short":"VT",ap:"Vt."},WA:{full:"Washington","short":"WA",ap:"Wash."},WI:{full:"Wisconsin","short":"WI",ap:"Wis."},WV:{full:"West Virginia","short":"WV",ap:"W.Va."},WY:{full:"Wyoming","short":"WY",ap:"Wyo."}},labelStyle:"short",index:"value",indexType:"numeric",colors:d3.scale.ordinal().range(["#f3f3f3"]),classIndex:!1,defaultColor:"#f3f3f3",tooltip:{enabled:!1,mode:"dynamic",el:".squaire-toolbox",layout:!1,whitelist:"*",column1:"",column2:"",noteIndex:!1},breakpoints:{"small-thumbnail":270,"small-xsmall":350,small:540,medium:940,large:""}};b=b||{},this.options=this.extend({},["tooltip"],d,b),"*"===this.options.tooltip.whitelist&&(this.options.tooltip.whitelist=this.getDataColumns(a)),this.$el=d3.select(this.options.el).append("div").attr({margin:0,padding:0}).node(),this.options.data=a,this.data=this.prepareData(c.options.layout,a),this.mapDimensions(),this.width=this.$el.getBoundingClientRect().width,this.height=this.width*this.ratio,this.breakpoint=this.getBreakpoint(),this.svg=d3.select(this.$el).append("svg").attr("class","squaire").attr("data-breakpoint",this.breakpoint),this.svg.attr({width:this.width,height:this.height});var e=function(a){var b="<h6>"+c.options.labels[a.box].full+'</h6><table class="table">';return(c.options.tooltip.column1||c.options.tooltip.column2)&&(b+="<tr><th>"+c.options.tooltip.column1+"</th><th>"+c.options.tooltip.column2+"</th></tr>"),c.options.tooltip.whitelist.forEach(function(c){void 0!==a.data&&a.data.hasOwnProperty(c)&&a.data[c]!==!1&&""!==a.data[c]&&(b+="<tr><td>"+c+"</td><td>"+a.data[c]+"</td></tr>")}),b+="</table>",void 0!==a.data&&a.data.hasOwnProperty(c.options.tooltip.noteIndex)&&a.data[c.options.tooltip.noteIndex]!==!1&&""!==a.data[c.options.tooltip.noteIndex]&&(b+='<div class="tooltip-note">'+a.data[c.options.tooltip.noteIndex]+"</div>"),b},f=this.options.tooltip.layout||e;this.options.tooltip.enabled&&(this.tip=d3.tip().attr("class","squaire-tooltip").direction(function(a){var b="n";return a.x<2?b="e":a.x>c.boxesWide-3?b="w":a.y<2&&(b="s"),b}).offset([6,6]).html(f).toolbox(c.options.tooltip.el),this.svg.call(this.tip),this.toolbox=d3.select(c.options.tooltip.el).attr("class","squaire-toolbox"),"static"!==this.options.tooltip.mode&&this.toolbox.style("display","none")),this.draw(),this.mapInteraction(),this.toggleTooltip();var g=this.debounce(this.resizeMap,250);return d3.select(window).on("resize."+this.options.el,g.bind(this)),this}return a.prototype.getDataColumns=function(a){var b=Object.keys(a[Object.keys(a)[0]]);return b=this.removeFromArray(b,this.options.classIndex),b=this.removeFromArray(b,this.options.tooltip.noteIndex)},a.prototype.removeFromArray=function(a,b){var c=a.indexOf(b);return-1!=c&&a.splice(c,1),a},a.prototype.prepareData=function(a,b){if("string"==typeof a){var c=[];return a=a.replace(/[\n\r]/g,"\n"),a.split("\n").forEach(function(a,d){a.split(/\t|,/).forEach(function(a,e){""!==a&&c.push({box:a,x:e,y:d,data:b[a]})})}),c}return a.map(function(a){return{x:a[0],y:a[1],box:a[2],data:b[a[2]]}})},a.prototype.extend=function(a){a=a||{};for(var b=[],c=1;c<arguments.length;c++){var d=arguments[c];if("[object Array]"!==Object.prototype.toString.call(d)){if(d)for(var e in d)if(d.hasOwnProperty(e))if("object"==typeof d[e]&&b.indexOf(e)>-1){var f={};"[object Array]"===Object.prototype.toString.call(d[e])&&(f=[]),a[e]=this.extend(f,a[e],d[e])}else a[e]=d[e]}else b=d}return a},a.prototype.debounce=function(a,b,c){var d;return function(){var e=this,f=arguments,g=function(){d=null,c||a.apply(e,f)},h=c&&!d;clearTimeout(d),d=setTimeout(g,b),h&&a.apply(e,f)}},a.prototype.getBreakpoint=function(){return this.width<this.options.breakpoints["small-thumbnail"]?"small-thumbnail":this.width<this.options.breakpoints["small-xsmall"]?"small-xsmall":this.width<this.options.breakpoints.small?"small":this.width<this.options.breakpoints.medium?"medium":"large"},a.prototype.toggleTooltip=function(){this.options.tooltip.enabled&&"toggle"===this.options.tooltip.mode&&("small"===this.breakpoint.slice(0,5)?this.toolbox.style("display","block"):this.toolbox.style("display","none"))},a.prototype.resizeMap=function(){this.width=this.$el.getBoundingClientRect().width,this.height=this.width*this.ratio,this.breakpoint=this.getBreakpoint();var a=this.boxDimensions();this.svg.attr({width:this.width,height:this.height}).attr("data-breakpoint",this.breakpoint),this.boxRect.attr("x",function(b){return a.xScale(b.x)}).attr("y",function(b){return a.yScale(b.y)}).attr({width:a.boxWidth,height:a.boxWidth}),this.updateText(a),this.toggleTooltip()},a.prototype.mapDimensions=function(){var a=d3.extent(this.data,function(a){return a.x}),b=d3.extent(this.data,function(a){return a.y});this.boxesWide=a[1]-a[0]+1,this.boxesTall=b[1]-b[0]+1,this.ratio=this.boxesTall/this.boxesWide},a.prototype.boxDimensions=function(){var a=d3.scale.linear().domain([0,this.boxesWide]).range([0,this.width]),b=d3.scale.linear().domain([0,this.boxesTall]).range([0,this.height]),c=this.width/this.boxesWide;return{xScale:a,yScale:b,boxWidth:c}},a.prototype.overlayColor=function(a){return a.length<5&&(a+=a.slice(1)),a.replace("#","0x")>8388607.5?"#333":"#fff"},a.prototype.colorMap=function(a){var b=this,c=this.options.indexType,d=this.options.colors;return this.boxRect.style("fill",function(e){if(void 0!==e.data&&e.data.hasOwnProperty(a)&&e.data[a]!==!1&&""!==e.data[a]){var f=e.data[a];return"numeric"===c&&(f=isNaN(f)?f.replace(/[^\d-\.]/gi,""):f),e.fill=d(f),e.index=a,d(f)}return e.fill=b.options.defaultColor,e.index=a,b.options.defaultColor}),this},a.prototype.updateText=function(a){var b=this;return this.boxText.attr("x",function(b){return a.xScale(b.x)+a.boxWidth/2}).attr("y",function(b){return a.yScale(b.y)+a.boxWidth/2}).text(function(a){return"small"===b.breakpoint.slice(0,5)?b.options.labels[a.box]["short"]:b.options.labels[a.box][b.options.labelStyle]}).style("fill",function(a){return b.overlayColor(a.fill)}),this},a.prototype.mapInteraction=function(){var a=this;return this.options.tooltip.enabled&&this.boxRect.on("mouseover",function(b,c){var d="toggle"===a.options.tooltip.mode&&"small"===a.breakpoint.slice(0,5)||"static"===a.options.tooltip.mode;a.tip.show(b,c,d),d3.selectAll("g.active").classed("active",!1);var e=d3.select(this.parentNode).classed("active",!0).node();e.parentNode.appendChild(e)}).on("mouseout",this.tip.hide),this},a.prototype.draw=function(){var a=this,b=this.boxDimensions(),c=this.svg.selectAll("g").data(this.data),d=c.enter().append("g");return d.append("rect"),d.append("text"),c.attr("data-box",function(a){return a.box}).attr("class",function(b){return void 0!==b.data&&b.data.hasOwnProperty(a.options.classIndex)&&b.data[a.options.classIndex]!==!1&&""!==b.data[a.options.classIndex]?b.data[a.options.classIndex]:""}),this.boxRect=c.select("rect").attr("x",function(a){return b.xScale(a.x)}).attr("y",function(a){return b.yScale(a.y)}).attr({width:b.boxWidth,height:b.boxWidth}).attr("class","box-rect"),this.boxText=c.select("text"),c.exit().remove(),this.colorMap(this.options.index),this.updateText(b),this},a.prototype.update=function(a,b){var c=this;return a=a||this.options.data,b=b||{},this.options=this.extend({},["tooltip"],this.options,b),"*"===this.options.tooltip.whitelist&&(this.options.tooltip.whitelist=this.getDataColumns(a)),this.data=this.prepareData(c.options.layout,a),this.mapDimensions(),this.draw(),this.options.tooltip.enabled&&this.toolbox.html(""),this.resizeMap(),this},a}();